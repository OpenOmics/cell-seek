---
title: "Preliminary QC Report for Multi-Sample Analysis"
subtitle: "Initial Sample Preprocessing - scATAC-seq"
date: '`r Sys.Date()`'
output:
    html_document:
        toc: true
        toc_float:
            collapsed: false
        number_sections: true
        code-fold: true
        toc_depth: 3
        fig_height: 5
        fig_width: 6
params:
  signacdir: signac
  samples: "sample1,sample2"
  defaultfilter: True
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning = FALSE, results='asis')
options(knitr.graphics.error = FALSE)
```

```{r Packages, message=FALSE}
library(knitr)
library(stringr)
library(flextable)
library(dplyr)
library(base64enc)
library(xfun)
```

```{r Input, include=FALSE}
signacdir <- params$signacdir
samples <- strsplit(params$samples, ",")[[1]] %>% trimws()
```

```{r, include=FALSE}
# Init Step to make sure that the dependencies are loaded
```

# QC Analysis

The data that was generated by Cell Ranger for `r length(samples)` samples was pulled into Signac. Samples were merged at the peak level by creating a union peak set and requantifying each sample against this union set prior to filtering.

**Samples analyzed:** `r paste(samples, collapse=", ")`

## Pre-Filter Violin Plots {.tabset}

Violin plots of the number of peaks accessible in a cell, number of unique fragments associated with a cell, TSS enrichment score, and nucleosome signal were created for each sample. Cells with extremely low or high number of fragments or peaks may indicate potential low quality cells and multiplets. Cells with low TSS enrichment score (<2) or high nucleosome signal indicate low quality cells that may not be of interest.

```{r, results='asis', fig.width=5, fig.height=7, out.width="70%"}
for (sample in samples) {
  cat(paste0("### ", sample, " {-}\n\n"))
  cat(paste0("![](", file.path(signacdir, paste0("PreFilter_VlnPlot_ATAC_", sample, ".png")), ")\n\n"))
}
```

## Pre-Filter Feature Plots {.tabset}

```{r, results='asis', fig.width=5, fig.height=7, out.width="70%"}
for (sample in samples) {
  cat(paste0("### ", sample, " {-}\n\n"))
  cat(paste0("![](", file.path(signacdir, paste0("PreFilter_Feature_Plot_", sample, ".png")), ")\n\n"))
}
```

## Pre-Filter TSS Enrichment Plots {.tabset}

TSS (Transcription Start Site) enrichment score is a key quality metric for ATAC-seq data. High-quality cells should show enrichment of signal at TSS regions. A TSS enrichment score >2 is generally considered good quality.

```{r, results='asis', fig.width=5, fig.height=7, out.width="70%"}
for (sample in samples) {
  cat(paste0("### ", sample, " {-}\n\n"))
  cat(paste0("![](", file.path(signacdir, paste0("PreFilter_TSS_Enrichment_Plot_", sample, ".png")), ")\n\n"))
}
```

## Pre-Filter Fragment Length Distribution {.tabset}

Fragment length distribution should show clear nucleosome banding pattern with peaks at approximately 200bp intervals, indicating high-quality ATAC-seq data with proper digestion.

```{r, results='asis', fig.width=5, fig.height=7, out.width="70%"}
for (sample in samples) {
  cat(paste0("### ", sample, " {-}\n\n"))
  cat(paste0("![](", file.path(signacdir, paste0("PreFilter_Fragment_Length_Plot_", sample, ".png")), ")\n\n"))
}
```

## Pre-Filter UMAP Plot {.tabset}

The following are the UMAP plots for the merged samples that were generated prior to filtering cells.

```{r, results='asis', fig.width=5, fig.height=7, out.width="70%"}
if (file.exists(file.path(signacdir, 'PreFilter_UMAP_ATAC.png'))) {
  cat("### By Sample{-}\n\n")
  cat(paste0("![](", file.path(signacdir, "PreFilter_UMAP_ATAC.png"), ")\n\n"))
}

if (file.exists(file.path(signacdir, 'PreFilter_UMAP_ATAC_Clusters.png'))) {
  cat("### Clustering{-}\n\n")
  cat(paste0("![](", file.path(signacdir, "PreFilter_UMAP_ATAC_Clusters.png"), ")\n\n"))
}

for (sample in samples) {
  if(file.exists(file.path(signacdir, paste0('PreFilter_UMAP_ATAC_Filter_', sample, '.png')))) {
    cat(paste0("### Filtered Cells - ", sample, " {-}\n\n"))
    cat(paste0("![](", file.path(signacdir, paste0("PreFilter_UMAP_ATAC_Filter_", sample, ".png")), ")\n\n"))
  }
}
```

## Pre-Filter QC Feature Plots {.tabset}

The following are feature plots showing the spatial distribution of QC metrics across the UMAP embedding prior to filtering.

```{r, results='asis', fig.width=5, fig.height=7, out.width="70%"}
for (sample in samples) {
  if (file.exists(file.path(signacdir, paste0('PreFilter_FeaturePlot_Counts_', sample, '.png')))) {
    cat(paste0("### ", sample, " - Count Metrics {-}\n\n"))
    cat(paste0("![](", file.path(signacdir, paste0("PreFilter_FeaturePlot_Counts_", sample, ".png")), ")\n\n"))
  }
  
  if(file.exists(file.path(signacdir, paste0('PreFilter_FeaturePlot_QC_', sample, '.png')))) {
    cat(paste0("### ", sample, " - QC Metrics {-}\n\n"))
    cat(paste0("![](", file.path(signacdir, paste0("PreFilter_FeaturePlot_QC_", sample, ".png")), ")\n\n"))
  }
}
```

## Cell Filter Thresholds

```{r Cell Filter, warning=FALSE, message=FALSE, results='asis', fig.width=5, fig.height=7, out.width="70%"}
if (params$defaultfilter) {
  cat("Adaptive thresholds based on the feature distributions were calculated separately for each sample to filter out potential low quality cells and multiplets. The values were log-transformed and a threshold of 3 median absolute deviations (MADs) above and below the median was calculated. Only a lower threshold was calculated for TSS enrichment and FRiP score, and only an upper threshold was calculated for nucleosome signal.^1^\n\n")
}else {
  cat("Thresholds were used to filter out potential low quality cells and multiplets for each sample.\n\n")
}
cat("The following are the thresholds that were set for each sample.\n\n")

thresh_df <- read.csv(file.path(signacdir, 'cell_filter_info.csv'))

get_value <- function(thresh, value) {
  if (is.null(thresh[[value]]) || is.na(thresh[[value]])) {NA} else{sprintf("%.2f", thresh[[value]])}
}

for (sample in samples) {
  cat(paste0("### ", sample, "\n\n"))
  
  thresh <- thresh_df[thresh_df$Sample == sample,]
  
  cat("Peak Count Thresholds:", paste0("(", get_value(thresh, "nFeature_peaks_low"), ", ", get_value(thresh, "nFeature_peaks_high"), ")"), "\n\n")
  
  cat("Fragment Count Thresholds:", paste0("(", get_value(thresh, "nCount_peaks_low"), ", ", get_value(thresh, "nCount_peaks_high"), ")"), "\n\n")
  
  cat("TSS Enrichment Threshold (minimum):", get_value(thresh, "TSS.enrichment_low"), "\n\n")
  
  cat("Nucleosome Signal Threshold (maximum):", get_value(thresh, "nucleosome_signal_high"), "\n\n")
  
  cat("FRiP Score Threshold (minimum):", get_value(thresh, "pct_reads_in_peaks_low"), "\n\n")
  
  cat("Total cells filtered:", get_value(thresh, "numCellsRemove"), "\n\n")
  
  cat("Percentage cells filtered:", get_value(thresh, "pctCellsRemove"), "%\n\n")
  
  printed <- c("nFeature_peaks_low", "nFeature_peaks_high", "nCount_peaks_low", "nCount_peaks_high",
               "TSS.enrichment_low", "nucleosome_signal_high", "pct_reads_in_peaks_low",
               "numCellsRemove", "pctCellsRemove", "Sample")
  
  if (length(setdiff(names(thresh), printed)) > 0) {
    cat("Additional thresholds used: \n\n")
    for (value in setdiff(names(thresh), printed)) {
      cat(paste0("* ", value, ": ", thresh[[value]], "\n"))
    }
    cat("\n\n")
  }
}

cat("\n**Total cells filtered across all samples:**", sum(thresh_df$numCellsRemove), "\n\n")
```


## Post-Filter Violin Plots {.tabset}

The following are the resulting violin plots generated after filtering the cells for each sample.

```{r, results='asis', fig.width=5, fig.height=7, out.width="70%"}
for (sample in samples) {
  if (file.exists(file.path(signacdir, paste0('PostFilter_VlnPlot_ATAC_', sample, '.png')))) {
    cat(paste0("### ", sample, " {-}\n\n"))
    cat(paste0("![](", file.path(signacdir, paste0('PostFilter_VlnPlot_ATAC_', sample, '.png')), ")\n\n"))
  }
}
```

## Post-Filter Feature Plots {.tabset}

```{r, results='asis', fig.width=5, fig.height=7, out.width="70%"}
for (sample in samples) {
  if (file.exists(file.path(signacdir, paste0('PostFilter_Feature_Plot_', sample, '.png')))) {
    cat(paste0("### ", sample, " {-}\n\n"))
    cat(paste0("![](", file.path(signacdir, paste0("PostFilter_Feature_Plot_", sample, ".png")), ")\n\n"))
  }
}
```

## Post-Filter TSS Enrichment Plots {.tabset}

```{r, results='asis', fig.width=5, fig.height=7, out.width="70%"}
for (sample in samples) {
  if (file.exists(file.path(signacdir, paste0('PostFilter_TSS_Enrichment_Plot_', sample, '.png')))) {
    cat(paste0("### ", sample, " {-}\n\n"))
    cat(paste0("![](", file.path(signacdir, paste0("PostFilter_TSS_Enrichment_Plot_", sample, ".png")), ")\n\n"))
  }
}
```

## Post-Filter Fragment Length Distribution {.tabset}

```{r, results='asis', fig.width=5, fig.height=7, out.width="70%"}
for (sample in samples) {
  if (file.exists(file.path(signacdir, paste0('PostFilter_Fragment_Length_Plot_', sample, '.png')))) {
    cat(paste0("### ", sample, " {-}\n\n"))
    cat(paste0("![](", file.path(signacdir, paste0("PostFilter_Fragment_Length_Plot_", sample, ".png")), ")\n\n"))
  }
}
```

## Post-Filter QC Feature Plots {.tabset}

The following are feature plots showing the spatial distribution of QC metrics across the UMAP embedding after filtering.

```{r, results='asis', fig.width=5, fig.height=7, out.width="70%"}
for (sample in samples) {
  if (file.exists(file.path(signacdir, paste0('PostFilter_FeaturePlot_Counts_', sample, '.png')))) {
    cat(paste0("### ", sample, " - Count Metrics {-}\n\n"))
    cat(paste0("![](", file.path(signacdir, paste0("PostFilter_FeaturePlot_Counts_", sample, ".png")), ")\n\n"))
  }
  
  if(file.exists(file.path(signacdir, paste0('PostFilter_FeaturePlot_QC_', sample, '.png')))) {
    cat(paste0("### ", sample, " - QC Metrics {-}\n\n"))
    cat(paste0("![](", file.path(signacdir, paste0("PostFilter_FeaturePlot_QC_", sample, ".png")), ")\n\n"))
  }
}
```

## Elbow Plot

The elbow plot shows the variance explained by each LSI component, helping to determine how many dimensions to use for downstream analysis.

```{r, results='asis', fig.width=5, fig.height=7, out.width="70%"}

cat(paste0("![](", file.path(signacdir, "ElbowPlot_LSI.png)")), "\n")
cat("\n")

```

## Post-Filter UMAP Plot {.tabset}

The following are the UMAP plots for the merged samples that were generated after filtering out the potential low quality and multiplet cells.

```{r, results='asis', fig.width=5, fig.height=7, out.width="70%"}
files <- Sys.glob(file.path(signacdir, "UMAP_peaks_res*.png"))
sil_files <- Sys.glob(file.path(signacdir, "SilhouetteResult_res*.csv"))
resolutions <- sapply(files, function(x) (x %>% basename %>% tools::file_path_sans_ext() %>% strsplit(split='res.'))[[1]][2]) %>% str_sort(numeric=T)
sil_mean <- sapply(resolutions, function(resolution) {filename <- grep(paste0('res.', resolution, '.csv'), sil_files, value=T); if(length(filename) > 0) { data <- read.csv(filename); mean(data$sil_width)} else{-Inf}})

if (file.exists(file.path(signacdir, 'UMAP_by_Sample.png'))) {
  cat("### By Sample {-}\n\n")
  cat(paste0("![](", file.path(signacdir, "UMAP_by_Sample.png)")), "\n\n")
}

if (max(sil_mean, na.rm=T) > -Inf) {
  cat("The average silhouette score and a silhouette plot was calculated for each cluster resolution. This was done by calculating the score for each cell using the euclidean distance generated based on the cell's LSI components to obtain an independent measure of the clustering results. The silhouette score ranges from -1 to 1, where: \n\n* 1 means that clusters are far apart and data points close to each other are assigned the same cluster label\n\n* 0 means that the distance between clusters are not signifcant and data points are close to more than one cluster\n\n* -1 means that clusters may be incorrectly assigned and data points are closer to other clusters than other data points in its own cluster\n\nThe resolution with the highest detected average silhouette score is resolution", sil_mean %>% which.max %>% names, "\n\n")
}

for (resolution in resolutions) {
  filename <- grep(paste0('res.', resolution, '.png'), files, value=T)
  cat("### Resolution", resolution, "{.tabset .tabset-fade .tabset-pills -}\n\n")
  cat(paste0("![](", filename, ')'), "\n\n")
  sil_filename <- filename %>% gsub(pattern = 'UMAP_peaks', replacement = "SilhouettePlot") %>% gsub(pattern=".png", replacement=".pdf")
  if (file.exists(sil_filename)) {
     data <- read.csv(sil_filename %>% gsub(pattern='Plot', replacement='Result') %>% gsub(pattern='pdf', replacement='csv'))
     cat("Average silhouette score:", mean(data$sil_width) %>% round(digits=3), "\n\n")
     print(xfun::embed_file(sil_filename, text = paste0("Download Silhouette Plot Resolution ", resolution)))
     cat("The silhouette plot itself labels the clusters starting from the number 1. The clusters are still in the order that is listed in the UMAP figure, it is just labeled from 1 onward.\n\n")
     cat("\n\n")
  }
}

```

# Session Info

``` {r Session Info, comment='', results='markup', attr.output='style="max-height: 500px;"'}
cat(readLines(file.path(signacdir, 'sessionInfo.txt')), sep="\n")
```

``` {r References, eval=params$defaultfilter}
cat("# References\n\n")
cat("1. Granja JM, Corces MR, Pierce SE, Bagdatli ST, Choudhry H, Chang HY, Greenleaf WJ. ArchR is a scalable software package for integrative single-cell chromatin accessibility analysis. Nat Genet. 2021 Mar;53(3):403-411. doi: 10.1038/s41588-021-00790-6. PMID: 33633365; PMCID: PMC7969724.\n\n")
cat("2. Stuart T, Srivastava A, Madad S, Lareau CA, Satija R. Single-cell chromatin state analysis with Signac. Nat Methods. 2021 Nov;18(11):1333-1341. doi: 10.1038/s41592-021-01282-5. PMID: 34725479; PMCID: PMC8654580.\n\n")
```

<div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 0;"></div>