---
title: "Preliminary QC Report for Sample `r params$sample`"
subtitle: "Initial Sample Preprocessing - scATAC-seq"
date: '`r Sys.Date()`'
output:
    html_document:
        toc: true
        toc_float:
            collapsed: false
        number_sections: true
        code-fold: true
        toc_depth: 3
        fig_height: 5
        fig_width: 6
params:
  signacdir: signac
  sample: sample
  defaultfilter: True
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning = FALSE, results='asis')
options(knitr.graphics.error = FALSE)
```

```{r Packages, message=FALSE}
library(knitr)
library(stringr)
library(flextable)
library(dplyr)
library(base64enc)
library(xfun)
```

```{r Input, include=FALSE}
signacdir <- params$signacdir
```

```{r, include=FALSE}
# Init Step to make sure that the dependencies are loaded
```

# QC Analysis

The data that was generated by Cell Ranger was pulled into Signac for initial processing.

## Pre-Filter Violin Plots

Violin plots of the number of peaks accessible in a cell, number of unique fragments associated with a cell, TSS enrichment score, and nucleosome signal were created. Cells with extremely low or high number of fragments or peaks may indicate potential low quality cells and multiplets. Cells with low TSS enrichment score (<2) or high nucleosome signal indicate low quality cells that may not be of interest.

```{r, results='asis', fig.width=5, fig.height=7, out.width="70%"}

cat(paste0("![](", file.path(signacdir, "PreFilter_VlnPlot_ATAC.png)")), "\n")
cat("\n")
```

## Pre-Filter Feature Plots

```{r, results='asis', fig.width=5, fig.height=7, out.width="70%"}

cat(paste0("![](", file.path(signacdir, "PreFilter_Feature_Plot.png)")), "\n")
cat("\n")

```

## Pre-Filter TSS Enrichment Plot

TSS (Transcription Start Site) enrichment score is a key quality metric for ATAC-seq data. High-quality cells should show enrichment of signal at TSS regions. A TSS enrichment score >2 is generally considered good quality.

```{r, results='asis', fig.width=5, fig.height=7, out.width="70%"}

cat(paste0("![](", file.path(signacdir, "PreFilter_TSS_Enrichment_Plot.png)")), "\n")
cat("\n")

```

## Pre-Filter Fragment Length Distribution

Fragment length distribution should show clear nucleosome banding pattern with peaks at approximately 200bp intervals, indicating high-quality ATAC-seq data with proper digestion.

```{r, results='asis', fig.width=5, fig.height=7, out.width="70%"}

cat(paste0("![](", file.path(signacdir, "PreFilter_Fragment_Length_Plot.png)")), "\n")
cat("\n")

```

## Pre-Filter UMAP Plot {.tabset}

The following are the UMAP plots for the sample that was generated prior to filtering cells.

```{r, results='asis', fig.width=5, fig.height=7, out.width="70%"}
if (file.exists(file.path(signacdir, 'PreFilter_UMAP_ATAC.png'))) {
  cat("### Clustering{-}\n\n")
  cat(paste0("![](", file.path(signacdir, "PreFilter_UMAP_ATAC.png)")), "\n")
}
cat("\n\n")
if(file.exists(file.path(signacdir, 'PreFilter_UMAP_ATAC_Filter.png'))) {
    cat("### Filtered Cells{-}\n\n")
    cat(paste0("![](", file.path(signacdir, "PreFilter_UMAP_ATAC_Filter.png)")), "\n")
}
cat("\n\n")

```

## Pre-Filter QC Feature Plots {.tabset}

The following are feature plots showing the spatial distribution of QC metrics across the UMAP embedding prior to filtering.

```{r, results='asis', fig.width=5, fig.height=7, out.width="70%"}
if (file.exists(file.path(signacdir, 'PreFilter_FeaturePlot_Counts.png'))) {
  cat("### Count Metrics{-}\n\n")
  cat(paste0("![](", file.path(signacdir, "PreFilter_FeaturePlot_Counts.png)")), "\n")
}
cat("\n\n")
if(file.exists(file.path(signacdir, 'PreFilter_FeaturePlot_QC.png'))) {
    cat("### QC Metrics{-}\n\n")
    cat(paste0("![](", file.path(signacdir, "PreFilter_FeaturePlot_QC.png)")), "\n")
}
cat("\n\n")

```

## Cell Filter Thresholds

```{r Cell Filter, warning=FALSE, message=FALSE, results='asis', fig.width=5, fig.height=7, out.width="70%"}
if (params$defaultfilter) {
  cat("Adaptive thresholds based on the feature distributions were used to filter out potential low quality cells and multiplets. The values were log-transformed and a threshold of 3 median absolute deviations (MADs) above and below the median was calculated. Only a lower threshold was calculated for TSS enrichment and FRiP score, and only an upper threshold was calculated for nucleosome signal.^1^\n\n")
}else {
  cat("Thresholds were used to filter out potential low quality cells and multiplets.\n\n")
}
cat("The following are the thresholds that were set for each set of statistics.\n\n")

thresh <- read.csv(file.path(signacdir, 'cell_filter_info.csv'))

printed <- c(apply(expand.grid(c("nFeature_peaks", "nCount_peaks"), c("low", "high")), 1, paste, collapse='_'), 
             "TSS.enrichment_low", "nucleosome_signal_high", "pct_reads_in_peaks_low",
             "numCellsRemove", "pctCellsRemove")

get_value <- function(thresh, value) {
  if (is.null(thresh[[value]])) {NA} else{sprintf("%.2f", thresh[[value]])}
}
cat("Peak Count Thresholds:", paste0("(", get_value(thresh, "nFeature_peaks_low"), ", ", get_value(thresh, "nFeature_peaks_high"), ")"), "\n\n")

cat("Fragment Count Thresholds:", paste0("(", get_value(thresh, "nCount_peaks_low"), ", ", get_value(thresh, "nCount_peaks_high"), ")"), "\n\n")

cat("TSS Enrichment Threshold (minimum):", get_value(thresh, "TSS.enrichment_low"), "\n\n")

cat("Nucleosome Signal Threshold (maximum):", get_value(thresh, "nucleosome_signal_high"), "\n\n")

cat("FRiP Score Threshold (minimum):", get_value(thresh, "pct_reads_in_peaks_low"), "\n\n")

cat("Total cells filtered:", get_value(thresh, "numCellsRemove"), "\n\n")

cat("Percentage cells filtered:", get_value(thresh, "pctCellsRemove"), "\n\n")

if (length(setdiff(names(thresh), printed) > 0)) {
  cat("The following additional thresholds were also used: \n\n")
  for (value in setdiff(names(thresh), printed)) {
    cat(paste0(value, ": ", thresh[[value]], "\n\n"))
    cat("\n\n")
  }
}
```


## Post-Filter Violin Plots {.tabset}

The following are the resulting violin plots generated after filtering the cells.

```{r, results='asis', fig.width=5, fig.height=7, out.width="70%"}
cat(paste0("![](", file.path(signacdir, 'PostFilter_VlnPlot_ATAC.png)')), "\n")

```

## Post-Filter Feature Plots

```{r, results='asis', fig.width=5, fig.height=7, out.width="70%"}

cat(paste0("![](", file.path(signacdir, "PostFilter_Feature_Plot.png)")), "\n")
cat("\n")

```

## Post-Filter TSS Enrichment Plot

```{r, results='asis', fig.width=5, fig.height=7, out.width="70%"}

cat(paste0("![](", file.path(signacdir, "PostFilter_TSS_Enrichment_Plot.png)")), "\n")
cat("\n")

```

## Post-Filter Fragment Length Distribution

```{r, results='asis', fig.width=5, fig.height=7, out.width="70%"}

cat(paste0("![](", file.path(signacdir, "PostFilter_Fragment_Length_Plot.png)")), "\n")
cat("\n")

```

## Post-Filter QC Feature Plots {.tabset}

The following are feature plots showing the spatial distribution of QC metrics across the UMAP embedding after filtering.

```{r, results='asis', fig.width=5, fig.height=7, out.width="70%"}
if (file.exists(file.path(signacdir, 'PostFilter_FeaturePlot_Counts.png'))) {
  cat("### Count Metrics{-}\n\n")
  cat(paste0("![](", file.path(signacdir, "PostFilter_FeaturePlot_Counts.png)")), "\n")
}
cat("\n\n")
if(file.exists(file.path(signacdir, 'PostFilter_FeaturePlot_QC.png'))) {
    cat("### QC Metrics{-}\n\n")
    cat(paste0("![](", file.path(signacdir, "PostFilter_FeaturePlot_QC.png)")), "\n")
}
cat("\n\n")

```

## Elbow Plot

The elbow plot shows the variance explained by each LSI component, helping to determine how many dimensions to use for downstream analysis.

```{r, results='asis', fig.width=5, fig.height=7, out.width="70%"}

cat(paste0("![](", file.path(signacdir, "ElbowPlot_LSI.png)")), "\n")
cat("\n")

```

## Post-Filter UMAP Plot {.tabset}

The following are the UMAP plots for the sample that was generated after filtering out the potential low quality and multiplet cells.

```{r, results='asis', fig.width=5, fig.height=7, out.width="70%"}
files <- Sys.glob(file.path(signacdir, "UMAP_peaks_res*.png"))
sil_files <- Sys.glob(file.path(signacdir, "SilhouetteResult_res*.csv"))
resolutions <- sapply(files, function(x) (x %>% basename %>% tools::file_path_sans_ext() %>% strsplit(split='res.'))[[1]][2]) %>% str_sort(numeric=T)
sil_mean <- sapply(resolutions, function(resolution) {filename <- grep(paste0('res.', resolution, '.csv'), sil_files, value=T); if(length(filename) > 0) { data <- read.csv(filename); mean(data$sil_width)} else{-Inf}})

if (max(sil_mean, na.rm=T) > -Inf) {
  cat("The average silhouette score and a silhouette plot was calculated for each cluster resolution. This was done by calculating the score for each cell using the euclidean distance generated based on the cell's LSI components to obtain an independent measure of the clustering results. The silhouette score ranges from -1 to 1, where: \n\n* 1 means that clusters are far apart and data points close to each other are assigned the same cluster label\n\n* 0 means that the distance between clusters are not signifcant and data points are close to more than one cluster\n\n* -1 means that clusters may be incorrectly assigned and data points are closer to other clusters than other data points in its own cluster\n\nThe resolution with the highest detected average silhouette score is resolution", sil_mean %>% which.max %>% names, "\n\n")
}

for (resolution in resolutions) {
  filename <- grep(paste0('res.', resolution, '.png'), files, value=T)
  cat("### Resolution", resolution, "{.tabset .tabset-fade .tabset-pills -}\n\n")
  cat(paste0("![](", filename, ')'), "\n\n")
  sil_filename <- filename %>% gsub(pattern = 'UMAP_peaks', replacement = "SilhouettePlot") %>% gsub(pattern=".png", replacement=".pdf")
  if (file.exists(sil_filename)) {
     data <- read.csv(sil_filename %>% gsub(pattern='Plot', replacement='Result') %>% gsub(pattern='pdf', replacement='csv'))
     cat("Average silhouette score:", mean(data$sil_width) %>% round(digits=3), "\n\n")
     print(xfun::embed_file(sil_filename, text = paste0("Download Silhouette Plot Resolution ", resolution)))
     cat("The silhouette plot itself labels the clusters starting from the number 1. The clusters are still in the order that is listed in the UMAP figure, it is just labeled from 1 onward.\n\n")
     cat("\n\n")
  }
}

```

# Session Info

``` {r Session Info, comment='', results='markup', attr.output='style="max-height: 500px;"'}
cat(readLines(file.path(signacdir, 'sessionInfo.txt')), sep="\n")
```

``` {r References, eval=params$defaultfilter}
cat("# References\n\n")
cat("1. Granja JM, Corces MR, Pierce SE, Bagdatli ST, Choudhry H, Chang HY, Greenleaf WJ. ArchR is a scalable software package for integrative single-cell chromatin accessibility analysis. Nat Genet. 2021 Mar;53(3):403-411. doi: 10.1038/s41588-021-00790-6. PMID: 33633365; PMCID: PMC7969724.\n\n")
cat("2. Stuart T, Srivastava A, Madad S, Lareau CA, Satija R. Single-cell chromatin state analysis with Signac. Nat Methods. 2021 Nov;18(11):1333-1341. doi: 10.1038/s41592-021-01282-5. PMID: 34725479; PMCID: PMC8654580.\n\n")
```

<div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 0;"></div>
